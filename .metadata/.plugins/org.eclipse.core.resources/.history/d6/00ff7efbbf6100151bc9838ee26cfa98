"use strict";

var logId = {
		value: -1	
};

(function() {
	function lastet() {
		var gui = new GUIManager(window, id);
		refresh(-1);
	}

	window.addEventListener("DOMContentLoaded", lastet);
})();

function refresh(id) {
	window.setTimeout(function() {
//		var gui = new GUIManager(window, id);
//		var http = new HTTPOperations("/endringer", updateMemberList);
		var http = new HTTPOperations("/endringer", gui.updateMemberList);
		http.getMembersByLogId(logId.value);
		refresh(gui._logId);
	}, 2000);	
}


//function updateMemberList(responseText) {
//	var obj = JSON.parse(responseText);
//	var obj = obj.updates;
//	if(obj.status) 
//		logId.value = obj.logId;
//
//	var table = document.getElementById("memberList");
//
//	var gui = new GUIManager(table, window);
//	if(obj.newMembers) {
//		if(obj.newMembers instanceof Array)
//			gui.createMembers(obj.newMembers);
//		else 
//			gui.createMembers([obj.newMembers]);
//	}
//	if(obj.deletedMembers) {
//		if(obj.deletedMembers instanceof Array) 
//			gui.deleteMembers(obj.deletedMembers);
//		else
//			gui.deleteMembers([obj.deletedMembers]);
//	}
//	if(obj.updatedMembers) {
//		if(obj.updatedMembers instanceof Array)
//			gui.updateMembers(obj.updatedMembers);
//		else
//			gui.updateMembers([obj.updatedMembers]);
//	}
//
//}

function buttonDelete(id) {
	return function() {
		var http = new HTTPOperations("/medlem", removeMember);
		http.deleteMemberById(id);
	}
}

function buttonEdit(id) {
	return function() {
		editMemberDialog(id);
	}
}

function removeMember(responseText) {
	var obj = JSON.parse(responseText);
	obj = obj.updatedMember;
	if(obj.status) {
		var table = document.getElementById("memberList");
		var gui = new GUIManager(/*table*/);
		gui.deleteMemberById(obj.memberId);
	}
}

function updateMember(responseText) {
	var obj = JSON.parse(responseText);
	obj = obj.updatedMember;
	var p = document.getElementById("fail");
	if(obj.status) {
		document.getElementById("manageMember").style.display = "none";
		p.innerHTML = "";
	} else {
		p.innerHTML = "woops! something went wrong!";
	}
}

function createMember(responseText) {
	var obj = JSON.parse(responseText);
	obj = obj.updatedMember;
	var p = document.getElementById("fail");
	if(obj.status) {
		document.getElementById("manageMember").style.display = "none";
		p.innerHTML = "";
	} else {
		p.innerHTML = "woops! something went wrong!";
	}
}

function editMemberDialog(id) {
	document.getElementById("manageMember").style.display = "inline";

	var row = document.getElementById("m"+id);

	function el(val) { return document.getElementById(val); };

	var fields = inputs();
	for(var x = 0; x < fields.length; x++) {
		fields[x].value = row.cells[x].innerHTML;
	}

	document.getElementById("submitMember").onclick = function() {
		var http = new HTTPOperations("/medlem", updateMember);
		var member = arrayToJSON(fields); //JSON OBJECT

		http.updateMember(id, member);

	
	}
}

function newMemberDialog() {
	document.getElementById("manageMember").style.display = "inline";

	var fields = inputs();
	for(var x = 0; x < fields.length; x++) {
		fields[x].value = "";
	}

	document.getElementById("submitMember").onclick = function() {
		var http = new HTTPOperations("/medlem", createMember);
		var member = arrayToJSON(fields); //JSON OBJECT
		http.createMember(member);
	}
}


function inputs() {
	function el(val) { return document.getElementById(val); };

	//see oppgave01.html under the div id="manageMember"
	return [el("fName"), el("lName"), el("address"), el("phone")];
}

function arrayToJSON(member) {
	return {
		"firstname": member[0].value,
		"lastname": member[1].value,
		"address": member[2].value,
		"phone": member[3].value
	}
}

